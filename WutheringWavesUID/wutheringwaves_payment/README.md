# 鳴潮機器人付費機制

## 概述

本付費機制為鳴潮機器人提供了分層的用戶權限系統，包括一般用戶和Premium會員兩種等級。付費機制不會影響正常使用，所有功能依然可用，但Premium會員享有更多專屬功能。

## 功能特點

### 一般用戶功能
- OCR使用PRO線路（高精度識別）
- 分析面板冷卻5.5分鐘（330秒，分析失敗則不計入）
- 綁定UID數：1個
- 默認面板圖
- 默認推送體力通知頻道
- 每日、卡片查詢冷卻3分鐘
- 解析系統冷卻3分鐘（失敗則不計入）

### Premium會員專享功能
- 自定義面板圖
- 自定義背景圖片（支持圖片上傳和URL）
- 自定義每日圖角色
- 綁定UID：不限制
- 自定義推送體力通知頻道
- 無冷卻限制
- OCR使用PRO線路（高精度識別）
- 無限制的解析系統

## 配置說明

### 基本配置
在 `config_default.py` 中新增了以下配置項：

```python
# 付費機制相關配置
"PremiumUsers": GsDictConfig(
    "Premium用戶列表",
    "Premium用戶列表，包含用戶ID和到期時間",
    {},
),
"RedeemCodes": GsDictConfig(
    "兌換碼列表",
    "兌換碼列表，包含兌換碼和相關信息",
    {},
),
"PaymentSystemEnabled": GsBoolConfig(
    "付費系統開關",
    "是否啟用付費系統",
    False,
),
"PremiumPrice": GsIntConfig(
    "Premium價格（台幣）",
    "Premium月費價格（台幣）",
    100,
    1000,
),
"DefaultCooldownAnalyze": GsIntConfig(
    "一般用戶分析冷卻時間（秒）",
    "一般用戶分析功能冷卻時間",
    330,
    3600,
),
"DefaultCooldownQuery": GsIntConfig(
    "一般用戶查詢冷卻時間（秒）",
    "一般用戶查詢功能冷卻時間",
    180,
    3600,
),
"DefaultCooldownParse": GsIntConfig(
    "一般用戶解析冷卻時間（秒）",
    "一般用戶解析功能冷卻時間",
    180,
    3600,
),
"DefaultMaxBindNum": GsIntConfig(
    "一般用戶最大綁定UID數",
    "一般用戶最大綁定UID數量",
    1,
    10,
),
```

## 指令說明

### 用户指令

#### 查看会员状态
```
我的会员
会员状态
查看会员
```

#### 付费说明
```
付费说明
会员说明
Premium说明
```

#### 使用兑换码
```
兑换 [兑换码]
使用兑换码 [兑换码]
```

#### Premium功能设置
```
Premium设置
Premium功能
会员功能
设置面板 [类型]
设置每日角色 [角色]
设置推送频道 [频道]
设置背景图片 [图片]
设置背景URL [URL]
查看面板选项
查看角色选项
查看推送频道选项
查看背景信息
重置背景
重置Premium设置
```

#### Premium綁定管理
```
Premium綁定狀態
Premium綁定列表
Premium綁定限制
綁定狀態
綁定列表
綁定限制
```

### 管理员指令

#### Premium用户管理
```
添加Premium [用户ID] [月数]
添加会员 [用户ID] [月数]
移除Premium [用户ID]
移除会员 [用户ID]
Premium用户列表
会员列表
查看Premium
```

#### 兑换码管理
```
新增兑换码 <数量><单位> [用户ID]
创建兑换码 <数量><单位> [用户ID]
兑换码列表
查看兑换码
```
- 支持时间单位：s(秒), m(分), h(时), d(天), M(月)
- 示例：`新增兑换码 30s`、`新增兑换码 5m`、`新增兑换码 1h`、`新增兑换码 7d`、`新增兑换码 1M`

#### 系统维护
```
清理过期数据
清理过期
```

## 技術實現

### 核心模組

1. **PaymentManager** - 付費機制管理器
   - 統一管理用戶等級和權限
   - 提供冷卻時間和綁定限制檢查
   - 管理兌換碼系統

2. **UserTierManager** - 用戶等級管理器
   - 管理Premium用戶列表
   - 處理用戶等級升級和降級
   - 自動清理過期用戶

3. **RedeemCodeManager** - 兌換碼管理器
   - 生成和管理兌換碼
   - 處理兌換碼使用和驗證
   - 自動清理過期兌換碼

4. **PremiumFeatures** - Premium功能管理器
   - 管理Premium專屬功能
   - 檢查功能使用權限
   - 提供自定義設置選項

5. **BackgroundManager** - 背景管理器
   - 管理用戶自定義背景圖片
   - 支持圖片上傳和URL設置
   - 自動回退到默認背景

### 增強功能

1. **EnhancedCooldownManager** - 增強版冷卻管理器
   - 支持付費機制的冷卻時間管理
   - 自動檢測Premium用戶並跳過冷卻
   - 向後兼容舊的訂閱系統

2. **ScheduledTasks** - 定時任務
   - 自動清理過期數據
   - 檢查Premium用戶到期情況
   - 系統維護和監控

## 數據結構

### Premium用戶數據格式
```json
{
    "user_id": {
        "permanent": false,
        "expire_time": 1704067200,
        "added_time": 1701388800
    }
}
```

### 兌換碼數據格式
```json
{
    "ABC123DEF456": {
        "months": 1,
        "target_user_id": null,
        "created_time": 1701388800,
        "expire_time": 1701648000,
        "used": false,
        "used_by": null,
        "used_time": null
    }
}
```

## 部署說明

1. 確保所有新文件已正確放置
2. 更新配置默認值
3. 重啟機器人以載入新功能
4. 使用管理員指令測試功能
5. 啟用付費系統（設置 `PaymentSystemEnabled` 為 `true`）

## 注意事項

1. 付費系統默認關閉，需要手動啟用
2. 所有功能都向後兼容，不會影響現有用戶
3. 兌換碼有效期為3天
4. 系統會自動清理過期數據
5. Premium用戶到期後會自動降級為一般用戶

## 故障排除

### 常見問題

1. **付費功能無法使用**
   - 檢查 `PaymentSystemEnabled` 是否為 `true`
   - 確認用戶是否為Premium會員
   - 檢查用戶是否已過期

2. **兌換碼無效**
   - 檢查兌換碼是否正確
   - 確認兌換碼是否已過期
   - 檢查是否已使用過

3. **冷卻時間異常**
   - 確認是否使用了增強版冷卻管理器
   - 檢查Premium用戶狀態
   - 查看系統日誌

### 日誌監控

系統會記錄以下重要事件：
- Premium用戶添加/移除
- 兌換碼創建/使用
- 過期數據清理
- 功能權限檢查

查看日誌以獲取詳細的錯誤信息和系統狀態。

## 🔍 OCR識別功能

### 用戶等級區分
- **一般用戶**: 使用PRO線路
  - 高精度識別
  - 有冷卻限制 (5.5分鐘/330秒)
  - 使用PRO引擎

- **Premium用戶**: 使用PRO線路
  - 高精度識別
  - 無冷卻限制
  - 使用PRO引擎

### OCR冷卻機制
- **一般用戶**: 5.5分鐘冷卻 (330秒)
- **Premium用戶**: 無冷卻限制
- 冷卻提示: `⏰ OCR功能冷卻中，請等待 X 秒後再試`

### 線路提示
- 一般用戶: `当前使用PRO線路，识别准确率高，330秒冷卻`
- Premium用戶: 無提示，直接使用高精度識別

### OCR指令
```
分析卡片
卡片分析
dc卡片
fx
分析
```

### 技術實現
- 自動根據用戶等級選擇API key
- 動態調整識別引擎
- 智能冷卻管理
- 錯誤處理和回退機制
