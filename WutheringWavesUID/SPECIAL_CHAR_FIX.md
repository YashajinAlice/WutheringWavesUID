# 特殊字符用戶名稱修復說明

## 問題描述
有用戶反映登入成功但只顯示 "retrying"，而其他用戶正常。該用戶的名稱包含特殊字符 `: ): ): )`。

## 問題分析
1. **"retrying" 錯誤來源**：來自 `kuro.py` 庫的 `get_player_info()` 方法
2. **根本原因**：用戶名稱中的特殊字符在數據處理過程中造成問題
3. **影響範圍**：JSON 序列化/反序列化、數據庫存儲、API 調用

## 修復方案
在登入處理流程中添加用戶名稱和角色名稱的字符清理邏輯：

### 1. 用戶名稱清理
- 位置：`WutheringWavesUID/wutheringwaves_login/login.py`
- 清理規則：保留字母、數字、中文、空格，移除其他特殊字符
- 正則表達式：`r'[^\w\s\u4e00-\u9fa5]'`
- 備用方案：如果清理後為空，使用時間戳生成唯一名稱

### 2. 角色名稱清理
- 在角色選擇處理中也應用相同的清理邏輯
- 確保所有存儲和顯示的名稱都是安全的

### 3. 修復位置
1. **機器人登入處理** (第 331-337 行)
2. **API 端點登入處理** (第 796-802 行)
3. **角色選擇處理** (第 1049-1055 行)
4. **機器人回調處理** (第 1258-1263 行)

## 修復效果
- 防止特殊字符導致的 "retrying" 錯誤
- 確保數據庫存儲的安全性
- 保持用戶體驗的一致性
- 提供備用命名機制

## 測試建議
1. 使用包含特殊字符的用戶名稱進行登入測試
2. 驗證角色選擇功能正常
3. 檢查數據庫存儲是否正確
4. 確認不再出現 "retrying" 錯誤

## 注意事項
- 清理後的名稱會記錄在日誌中，便於調試
- 如果清理後名稱為空，會自動生成唯一標識
- 不影響正常用戶名稱的處理

